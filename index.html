export const config = {
  api: {
    bodyParser: false
  }
};

import multer from "multer";
import Cors from "cors";

const cors = Cors({
  methods: ["POST"],
  origin: "*"
});

function runMiddleware(req, res, fn) {
  return new Promise((resolve, reject) => {
    fn(req, res, (result) => {
      if (result instanceof Error) return reject(result);
      return resolve(result);
    });
  });
}

const upload = multer({ storage: multer.memoryStorage() });

export default async function handler(req, res) {
  await runMiddleware(req, res, cors);

  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  const apiKey = req.headers["x-api-key"];
  if (!apiKey || apiKey !== process.env.API_KEY) {
    return res.status(401).json({ error: "Unauthorized" });
  }

  await new Promise((resolve, reject) => {
    upload.single("image")(req, res, (err) => {
      if (err) reject(err);
      else resolve();
    });
  });

  const category = (req.body.category || "").toLowerCase();
  const allowed = ["cardboard", "glass", "metal", "paper", "plastic", "trash"];
  if (!allowed.includes(category)) {
    return res.status(400).json({ error: "Invalid category" });
  }

  if (!req.file) return res.status(400).json({ error: "No image" });

  const mime = req.file.mimetype;
  if (!mime.startsWith("image/")) {
    return res.status(400).json({ error: "Invalid image" });
  }

  const base64 = req.file.buffer.toString("base64");
  const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
  const ext = mime.split("/")[1];
  const filename = `${category}_${timestamp}.${ext}`;

  const path = `Dataset/${category}/${filename}`;

  const repo = process.env.REPO; // "sumiyajid/RecycleBinDataCollection"

  const branchResp = await fetch(`https://api.github.com/repos/${repo}`, {
    headers: { Authorization: `token ${process.env.GITHUB_TOKEN}` }
  });

  const repoData = await branchResp.json();
  const branch = repoData.default_branch || "main";

  const uploadResp = await fetch(
    `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`,
    {
      method: "PUT",
      headers: {
        Authorization: `token ${process.env.GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Add ${category} image ${filename}`,
        content: base64,
        branch
      })
    }
  );

  const result = await uploadResp.json();

  if (!uploadResp.ok) {
    return res.status(500).json({ error: result.message || "Upload failed" });
  }

  res.json({ ok: true, file: result.content });
}
