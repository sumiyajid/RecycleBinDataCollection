<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recycle Waste Dataset Collection</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#4CAF50,#45a049);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
      padding: 18px;
      max-width: 520px;
      width: 100%;
    }
    h1 { text-align:center; color:#2E7D32; margin-bottom:14px; font-size:20px; }
    .category-selection { margin-bottom:16px; }
    .category-selection label { display:block; margin-bottom:8px; font-weight:700; color:#333; font-size:14px; }
    .category-grid {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
    }
    .category-option {
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px;
      border:2px solid #ddd;
      border-radius:8px;
      cursor:pointer;
      transition:all .18s ease;
      font-size:13px;
      background:#fff;
    }
    .category-option:hover { border-color:#4CAF50; background:#f7fff7; }
    .category-option input[type="radio"] { accent-color: #4CAF50; width:18px; height:18px; }
    .category-option.selected { border-color:#4CAF50; background:#e8f5e8; }
    .camera-section { text-align:center; margin-bottom:14px; }
    #video {
      width:100%;
      aspect-ratio:4/3;
      border-radius:10px;
      border:2px solid #ddd;
      object-fit:cover;
      background:#000;
    }
    .button-group { display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
    button {
      padding:10px 18px;
      border:none;
      border-radius:22px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:transform .12s ease;
      min-width:120px;
    }
    button:active { transform:translateY(1px); }
    #startCamera { background:#4CAF50; color:#fff; }
    #capturePhoto { background:#2196F3; color:#fff; }
    #sendData { background:#FF9800; color:#fff; }
    #photoPreview { max-width:100%; max-height:220px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.18); display:block; margin: 0 auto 10px auto; }
    .status { text-align:center; padding:10px; border-radius:6px; margin-bottom:6px; font-size:14px; display:none; }
    .status.success { background:#d4edda; color:#155724; display:block; }
    .status.error { background:#f8d7da; color:#721c24; display:block; }
    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; border:0; padding:0; margin:-1px; }
    small.hint { display:block; text-align:center; color:#333; margin-bottom:8px; font-size:12px; }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="title">
    <h1 id="title">üå± Recycle Waste Dataset Collection</h1>

    <div class="category-selection" aria-label="Waste category selection">
      <label for="categories">Select Waste Category:</label>
      <div id="categories" class="category-grid">
        <!-- Use real radio inputs for accessibility and value binding -->
        <label class="category-option" data-category="cardboard">
          <input type="radio" name="category" value="cardboard" aria-label="Cardboard"> üì¶ Cardboard
        </label>
        <label class="category-option" data-category="glass">
          <input type="radio" name="category" value="glass" aria-label="Glass"> üç∂ Glass
        </label>
        <label class="category-option" data-category="metal">
          <input type="radio" name="category" value="metal" aria-label="Metal (Can)"> ü•´ Metal (Can)
        </label>
        <label class="category-option" data-category="paper">
          <input type="radio" name="category" value="paper" aria-label="Paper"> üìÑ Paper
        </label>
        <label class="category-option" data-category="plastic">
          <input type="radio" name="category" value="plastic" aria-label="Plastic Bottle"> üß¥ Plastic Bottle
        </label>
        <label class="category-option" data-category="organic">
          <input type="radio" name="category" value="organic" aria-label="Organic waste"> üóë Organic Waste
        </label>
      </div>
    </div>

    <div class="camera-section">
      <video id="video" autoplay muted playsinline aria-label="Camera preview"></video>
      <canvas id="canvas" style="display:none;"></canvas>
      <img id="photoPreview" alt="Captured photo preview" style="display:none;">
      <small class="hint">Tap "Start Camera" then "Capture Photo". Use the category you selected.</small>
    </div>

    <div class="button-group" role="group" aria-label="camera controls">
      <button id="startCamera" type="button">Start Camera</button>
      <button id="capturePhoto" type="button" disabled>Capture Photo</button>
    </div>

    <div class="button-group">
      <button id="sendData" type="button" disabled>Send to Dataset</button>
    </div>

    <div id="status" role="status" aria-live="polite" class="status"></div>
  </div>

<script>
  // Variables
  let stream = null;
  let selectedCategory = null;
  let capturedImageData = null;
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const captureBtn = document.getElementById('capturePhoto');
  const startBtn = document.getElementById('startCamera');
  const sendBtn = document.getElementById('sendData');
  const statusEl = document.getElementById('status');
  const photoPreview = document.getElementById('photoPreview');
  const categoryOptions = document.querySelectorAll('.category-option');

  // Helper: show status
  function showStatus(text, type = '') {
    statusEl.textContent = text;
    statusEl.className = 'status' + (type ? ' ' + type : '');
  }

  // CATEGORY selection handling (works with labels and real inputs)
  categoryOptions.forEach(label => {
    const input = label.querySelector('input[type="radio"]');
    label.addEventListener('click', (e) => {
      // If clicking label, the radio will become checked; sync UI classes and selectedCategory
      categoryOptions.forEach(l => l.classList.remove('selected'));
      label.classList.add('selected');
      selectedCategory = input.value;
      input.checked = true;
      updateSendButton();
    });
    // support keyboard / direct radio change
    input.addEventListener('change', () => {
      categoryOptions.forEach(l => l.classList.remove('selected'));
      label.classList.add('selected');
      selectedCategory = input.value;
      updateSendButton();
    });
  });

  // UPDATE send button enabled state
  function updateSendButton() {
    sendBtn.disabled = !(selectedCategory && capturedImageData);
  }

  // START CAMERA
  startBtn.addEventListener('click', async () => {
    if (stream) {
      // Toggle off if already started
      stopStream();
      startBtn.textContent = 'Start Camera';
      captureBtn.disabled = true;
      showStatus('Camera stopped.');
      return;
    }
    try {
      // Prefer environment-facing camera on mobile
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 960 } },
        audio: false
      });
      video.srcObject = stream;
      startBtn.textContent = 'Stop Camera';
      captureBtn.disabled = false;
      showStatus('Camera started!', 'success');
    } catch (err) {
      console.error(err);
      showStatus('Camera error. Check permissions and HTTPS.', 'error');
    }
  });

  function stopStream() {
    if (!stream) return;
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
  }

  // Stop camera when leaving page or reloading
  window.addEventListener('pagehide', stopStream);
  window.addEventListener('beforeunload', stopStream);

  // CAPTURE PHOTO
  captureBtn.addEventListener('click', () => {
    if (!stream) {
      showStatus('Camera is not active.', 'error');
      return;
    }
    // Use fixed capture size but match aspect ratio of video element for predictability
    const captureW = 1024;
    const captureH = Math.round(captureW * (video.videoHeight / video.videoWidth || (3/4)));
    canvas.width = captureW;
    canvas.height = captureH;
    const ctx = canvas.getContext('2d');
    // draw current frame
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    // Convert to JPEG with quality
    capturedImageData = canvas.toDataURL('image/jpeg', 0.85);
    photoPreview.src = capturedImageData;
    photoPreview.style.display = 'block';
    updateSendButton();
    showStatus('Photo captured!', 'success');
  });

  // Convert dataURL to Blob
  function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8 = new Uint8Array(n);
    while (n--) u8[n] = bstr.charCodeAt(n);
    return new Blob([u8], { type: mime });
  }

  // Create a unique filename
  function makeFilename(category) {
    const ts = new Date().toISOString().replace(/[:.]/g, '-');
    return `${category}_${ts}.jpg`;
  }

  // UPLOAD to server with basic timeout and error handling
  async function uploadToServer(imageDataUrl, category) {
    const blob = dataURLtoBlob(imageDataUrl);
    const form = new FormData();
    form.append('image', blob, makeFilename(category));
    form.append('category', category);

    // Adjust this endpoint to your backend. Use HTTPS and CORS configured server-side.
    const UPLOAD_URL = 'https://YOUR_VERCEL_URL/api/upload';

    // Simple fetch with AbortController for timeout
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 30000); // 30s timeout

    try {
      const resp = await fetch(https://recycle-bin-data-collection.vercel.app/, {
        method: 'POST',
        headers: {
          // keep authentication secure - do not hardcode keys in client in production
          // 'x-api-key': 'YOUR_API_KEY'
        },
        body: form,
        signal: controller.signal
      });
      clearTimeout(timeout);
      if (!resp.ok) {
        const text = await resp.text().catch(()=>null);
        // try JSON
        let json = null;
        try { json = JSON.parse(text); } catch(e){}
        const errMsg = (json && (json.error || json.message)) || text || resp.statusText;
        throw new Error(errMsg || 'Upload failed');
      }
      return resp.json();
    } catch (err) {
      if (err.name === 'AbortError') throw new Error('Upload timed out');
      throw err;
    }
  }

  // SEND DATA button
  sendBtn.addEventListener('click', async () => {
    if (!capturedImageData || !selectedCategory) {
      showStatus('Capture a photo and select a category first.', 'error');
      return;
    }
    sendBtn.disabled = true;
    sendBtn.textContent = 'Uploading...';
    showStatus('Uploading...', '');

    try {
      const result = await uploadToServer(capturedImageData, selectedCategory);
      showStatus('Uploaded to dataset!', 'success');
      // Optionally clear preview & selection after successful upload:
      // capturedImageData = null;
      // photoPreview.style.display = 'none';
      // categoryOptions.forEach(l => l.classList.remove('selected'));
      // document.querySelectorAll('input[name="category"]').forEach(i => i.checked = false);
      // selectedCategory = null;
      // updateSendButton();

      console.log('Upload result:', result);
    } catch (err) {
      console.error(err);
      showStatus('Upload failed: ' + (err.message || 'Unknown error'), 'error');
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send to Dataset';
    }
  });

  // Accessibility: enable Enter key on video for capture
  video.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !captureBtn.disabled) captureBtn.click();
  });

</script>
</body>
</html>
